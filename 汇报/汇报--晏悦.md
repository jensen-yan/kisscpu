实验报告-- 晏悦
=====

# 1. 技术指标

阐述处理器的设计指标. 可以包括以下内容:

* 使用何种指令集
  * RV64 IM Machine态
* 支持哪些扩展
  * M扩展
* 面向何种应用场景
  * 暂无
* 预期的性能指标 

有余力的同学可以调研同类竞品, 进行比较分析.

# 2. 微结构设计

阐述处理器的微架构设计细节. 这一部分至少需要包括:

* 处理器的整体微架构示意图

  * ![image-20210111150542060](/home/yanyue/.config/Typora/typora-user-images/image-20210111150542060.png)

* 处理器的流水线设计

  * 参考国科大体系结构实验课课程设计, 每一级流水线有valid信号控制当前流水线缓存信号是否有效, 有 ready_go来控制本级流水线是否阻塞,    fs_to_ds_valid, ds_allowin 握手成功才有流水线之间的传递信号.

  * ```scala
      // IF stage
      fs_ready_go := true.B
      fs_allowin := !fs_valid || fs_ready_go && io.ds_allowin
      val fs_to_ds_valid = fs_valid && fs_ready_go
      
      val fs_kill = dec_pc_sel =/= PC_4    // 如果dec是转移指令, 对下一拍的ds_valid刷新, 当前拍取出的指令= nop
      
      when(fs_allowin) {
        fs_valid := to_fs_valid
      }
      
      when(to_fs_valid && fs_allowin) {
        if_reg_pc := npc
      }
    ```

* 处理器的对外接口

  * ```scala
    class ysyx_yanyue extends Module{
      val io = IO(new Bundle() {
        val mem       = Flipped(new AXI_interface)
        val mmio      = Flipped(new AXI_lite_interface)
        val mtip      = Input(Bool())
        val meip      = Input(Bool())
      })
    ```

* 处理器中各个组件的分析

  * ![image-20210111151434123](/home/yanyue/.config/Typora/typora-user-images/image-20210111151434123.png)

* 设计的模块在可重用性上有哪些考虑？具体有哪些体现？

  * 由于处理器设计的比较简单, 具体的没有实现模块的可重用性.
  * 思考: 可以把两级流水线之间的控制传递逻辑给抽象化, 这样5级流水之间就都可以重复调用这一模块.

有余力的同学可以考虑以下问题:

* 处理器设计的亮点
* 根据微架构设计, 分析性能瓶颈, 面积瓶颈，功耗瓶颈

# 3. 验证环境

描述处理器开发使用的验证环境, 可以包括以下内容:

* 验证环境的搭建
  * 总体环境: Deepin V20 操作系统, Intellij IDEA 集成开发环境
  * 首先克隆下来chisel-template 项目, 在IDEA安装sbt等组件.
  * 只使用scala进行开发小模块, 使用peekpoke验证
  * 安装verilator, 生成verilog代码, 参考nutshell搭建测试环境.
  * chisel模块内打印各个变量值初步调试, 对于较为复杂的bug也可以打开波形调试 
  * 最后使用ssh远程连接到服务器进行验证, 但是由于我操作系统版本问题, 一直没能使用ssh -X 图形化界面, 来直接用vcs的看波形调试, 还是使用的打印调试的方法.
* 验证环境的架构
  * 对于小模块的验证: 使用自带的peekpoke进行验证.
  * 对于ISA正确性: 参考nutshell的实现方法, 使用sbt生成scala的verilog代码, 再用verilator调用riscv64-nemu-interpreter-so 这个动态链接库, 每一拍都让DUT, REF 各走一步, 比较两者的pc, 32个通用寄存器是否相同.
  * 测试文件在nexus-am/tests/cputest/build 中, 使用了软链接到顶层目录中
* 描述一条指令在验证环境中执行的细节
  * 对于lui指令, 在nemu中, 首先从测试文件中读出这条指令的二进制格式, 进行译码, 执行, 写回到regfile中, 顺序执行完毕.
  * 在chisel中, 对于我的5级流水线CPU, 这一条指令至少需要5拍才能执行结束, 当写回级成功后, 发出commit信号.
  * 所以在verilator中, 对DUT先走几拍reset, 然后每拍执行, 只有当commit == 1 时候, 再执行nemu一次, 获取正确的pc, regs信息, 和DUT进行对比, 错误则输出信息.  
* 分析现有验证环境的不足
  * 我自己在Makefile中手动修改测试哪一个文件, 可以用python脚本来一键化自动测试的
  * 对于内存修改指令load store, 之前用C语言实现的大数组来模拟内存, 可以手动打印内存内某个地址的值来debug, 但每次都要修改打印地址, 应该可以更好的集成到测试框架中.
  * 现在还直接申请大数组来模拟内存, 对于更大空间的访问(64位地址支持4TB以上的物理地址访问)就不能这样了, 应该在C语言中实现TLB类似的虚实地址映射, 在使用某一地址时候, 申请分配一页的地址, 并建立虚实地址映射关系.

# 4. 验证/性能分析结果

描述基于自行搭建的验证框架的处理器功能验证结果. 可以包括以下内容:

* 如何验证各个指令扩展实现的正确性
  * 在am的测试文件中, 有些指令会用到乘除法指令, 所以可以利用已有的测试框架进行测试. 
* 描述处理器设计已经通过了哪些测试
  * 能通过am/tests/cputest 中所有的测试

描述在仿真验证中遇到的代表性问题和解决方案.

给出基于仿真的处理器性能分析. 建议基于仿真运行常用的嵌入式性能测试程序, 并添加性能计数器以辅助分析.

描述在SOC测试中遇到的问题, 以及解决方案.

# 5. 其他工作

描述围绕着这一项目进行的其他工作, 如RT-Thread操作系统的适配.

# 6.总结感悟

总结迄今为止在整个项目中的收获, 为下一期项目提出建议.

收获:

1. 熟悉了验证框架应该如何搭建, 使用, 改进. 完整的阅读了nemu项目也跟着南京大学的课程做了一部分改进, 最后其实还是用的适配好nutshell的nemu进行的调试, 不过还是对验证框架了解的更全面了.
2. 对chisel语言更加熟悉, 至少能初步实现verilog到chisel的翻译, 能理解class, trait, object的区别, 能写简单的测试程序, 能看懂soder, nutshell的代码, 也简单学了一遍scala的高阶用法
4. 电路图对设计电路非常重要, 之前都是脑中自己想时序, 非常混乱, 很难理解时序, 并且最开始一直生成不了波形, 没法用看波形调试, 只能chisel每一拍打印, 但组合电路打印和时序电路打印略有区别, 导致最开始debug一直很痛苦.
5. 划分成模块非常重要, 避免一个模块几百行. 因为最开始参考soder的五级流水线, 就是数据通路全部放在datapath这个模块中, 但是别人是大师的设计, 很理解每级流水线之间的数据传递, 我一上来也这样用, 经常分不清这个信号是从哪一级流水线的, 对时序理解就很不到位. 在后期完全重构, 拆分成5个模块, 画好了电路图, 把复杂的拆成简单的, 整个思考复杂度就降下来了, 脑容量的Cache压力也减轻了, 这也挺能体现KISS原则的.
6. 前期走了很多弯路吧, 确实一个人探索搭建框架, 有时候一个小问题就能卡很久, 进而怀疑自己的能力,  产生懈怠心理, 不愿意去面对问题, 解决问题, 等熬了很长时间真正解决问题时候, 才发现柳暗花明又一村, 问题其实很好解决. 现在回顾这小半年的工作, 都觉得好像没做什么工作, 看起来似乎很容易就能做好, 但这也是站在过来者的身份, 亲身体验又是另一番滋味了, 也不宜妄自菲薄吧. 
7. 能尽早开始写代码非常重要, 看代码10天都比不上写代码1天, 真正只有写代码才能检验是否理解了那些代码. 在开学的前一个月左右, 都一直怀着恐惧的心理不敢去搭框架, 觉得没有框架就完全不敢写代码, 就一直彷徨着看nutshell, nemu, am的代码, 试图理解之后再开始写代码, 结果又不太能看懂代码, 就更不敢写代码, 陷入一个死循环   (这一段心路历程很切合9月11日讨论时, 于子濠师兄对我们的分析)



对下一期项目的建议:

1. 还是很支持下一期项目, 像我们这一期这样从头开始搭建项目的, 对于我个人来说, 这是第一次自己探索着写一个复杂项目, 从前期非常迷茫, 大量阅读代码, 到中期开始写简单代码慢慢入门, 到后期重构代码, 更加得心应手. 虽然最后我的成果比较一般, 但这段经历十分宝贵. 从心智上, 从能力上, 都让我有很多收获. 
2. 建议能线下集中讨论, 或者线下集中开发. 之前去过一次中关村集中开发环境那里, 待了一天, 当时效率确实很高. 另外在学校这边也找过杨宇恒, 陈熙同学讨论, 能够很快的找准问题并解决. 也能很好的避免一种孤独感, 督促自己进步.



